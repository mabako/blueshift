--------- [ Vehicle Shops ] ---------
local shops = 
{ 
	{
		{
			{ 562.9052, -1291.2724, 16.9763, 358 },
			{ 555.9052, -1291.2724, 16.9763, 358 },
			{ 548.9052, -1291.2724, 16.9763, 358 },
			{ 541.9052, -1291.2724, 16.9763, 358 },
			{ 534.9052, -1291.2724, 16.9763, 358 },
			{ 527.9052, -1291.2724, 16.9763, 358 },
			{ 520.9052, -1291.2724, 16.9763, 358 },
			{ 562.9052, -1281.2724, 16.9763, 358 },
			{ 555.9052, -1281.2724, 16.9763, 358 },
			{ 548.9052, -1281.2724, 16.9763, 358 },
			{ 541.9052, -1281.2724, 16.9763, 358 },
			{ 534.9052, -1281.2724, 16.9763, 358 },
			{ 562.9052, -1271.2724, 16.9763, 358 },
			{ 555.9052, -1271.2724, 16.9763, 358 },
			{ 548.9052, -1271.2724, 16.9763, 358 }
		},
		
		{
			{ "Buffalo", 51000 },
			{ "Phoenix", 75000 },
			{ "Banshee", 89000 },
			{ "Jester",  74000 },
			{ "Cheetah", 140000 },
			{ "Comet",   70000 },
			{ "Sultan",  45000 },
			{ "Elegy",   42000 },
			{ "Flash",   32000 },  
			{ "Uranus",  56000 },
			{ "Turismo", 200000 },
			{ "Infernus", 220000 },
			{ "Bullet", 130000 },
			{ "Super GT", 110000 },
			{ "ZR-350", 75000 },
			{ "Windsor", 43500 },
			{ "Feltzer", 61000 },
			{ "Euros", 48000 }
		}	
	},

	{
		{
			{ 1098.3671, -1775.6113, 13.1000, 90 },
			{ 1098.3671, -1769.6113, 13.1000, 90 },
			{ 1098.3671, -1763.6113, 13.1000, 90 },
			{ 1098.3671, -1757.6113, 13.1000, 90 },
			{ 1083.8710, -1775.5078, 13.1000, 270 },
			{ 1083.8710, -1769.5078, 13.1000, 270 },
			{ 1083.8710, -1763.5078, 13.1000, 270 },
			{ 1083.8710, -1757.5078, 13.1000, 270 },
			{ 1077.6035, -1775.7451, 13.1227, 90 },
			{ 1077.6035, -1769.7451, 13.1227, 90 },
			{ 1077.6035, -1763.7451, 13.1227, 90 },
			{ 1077.6035, -1757.7451, 13.1227, 90 },
			{ 1062.5878, -1775.6416, 13.1000, 270 },
			{ 1062.5878, -1769.6416, 13.1000, 270 },
			{ 1062.5878, -1763.6416, 13.1000, 270 },
			{ 1062.5878, -1757.6416, 13.1000, 270 },
			{ 1062.5878, -1751.6416, 13.1000, 270 },
			{ 1062.5878, -1745.6416, 13.1000, 270 },
			{ 1062.5878, -1739.6416, 13.1000, 270 }
		},
		
		{
			{ "Hustler", 18000 },
			{ "Blista Compact", 17000 },
			{ "Majestic", 11000 },
			{ "Bravura", 15000 },
			{ "Manana", 7000 },
			{ "Picador", 13000 },
			{ "Cadrona", 13000 },
			{ "Previon", 7000 },
			{ "Club", 9000 },
			{ "Stallion", 10000 },
			{ "Tampa", 7000 },
			{ "Fortune", 13000 },
			{ "Virgo", 15000 },
			{ "Admiral", 23000 },
			{ "Premier", 25000 },
			{ "Elegant", 22000 },
			{ "Primo", 18000 },
			{ "Emperor", 20000 },
			{ "Sentinel", 18500 },
			{ "Sunrise", 14000 },
			{ "Greenwood", 15000 },
			{ "Tahoma", 14000 },
			{ "Intruder", 16000 },
			{ "Vincent", 18000 },
			{ "Merit", 23000 },
			{ "Washington", 41000 },
			{ "Nebula", 22000 },
			{ "Willard", 15000 },
			{ "Walton", 6900 },
			{ "Clover", 5000 },
			{ "Sadler", 12000 },
			{ "Rumpo", 18000 },
			{ "Rancher", 23000 },
			{ "Moonbeam", 8000 },
			{ "Pony", 9000 },
			{ "Regina", 11500 },
			{ "Bobcat", 19000 },
			{ "Perennial", 10000 },
			{ "Camper", 27000 },
			{ "Burrito", 19000 },
			{ "Solair", 19500 },
			{ "Stratum", 31000 },
			{ "Yosemite", 34000 },
			{ "Patriot", 37000 },
			{ "Landstalker", 45000 },
			{ "Huntley", 29000 },
			{ "Mesa", 14500 },
			{ "Savanna", 18000 },
			{ "Blade", 17000 },
			{ "Broadway", 48000 },
			{ "Remington", 22000 },
			{ "Slamvan", 18000 },
			{ "Tornado", 16500 },
			{ "Voodoo", 7800 },
			{ "Oceanic", 14000 },
			{ "Glendale", 13000 },
			{ "Buccaneer", 14000 },
			{ "Esperanto", 13000 },
			{ "Hermes", 23000 }
		}
	},
	
	{
		{
			{ 2117.9296, -1131.3964, 24.8102, 267 },
			{ 2116.9296, -1137.3964, 24.8102, 267 },
			{ 2116.9296, -1143.3964, 24.8102, 267 },
			{ 2116.9296, -1149.3964, 24.8102, 267 },
			{ 2116.9296, -1155.3964, 24.8102, 267 },
			{ 2137.5888, -1131.5215, 25.2690, 85 },
			{ 2137.5888, -1137.5215, 25.2690, 85 },
			{ 2137.5888, -1143.5215, 25.2690, 85 },
			{ 2137.5888, -1149.5215, 25.2690, 85 }

		},
		
		{
			{ "BF-400", 16000 },
			{ "NRG-500", 60000 },
			{ "PCJ-600", 18000 },
			{ "Faggio", 1400 },
			{ "Pizzaboy", 1650 },
			{ "FCR-900", 12000 },
			{ "Sanchez", 5500 },
			{ "Freeway", 19500 },
			{ "Wayfarer", 1400 },
			{ "Quadbike", 3000 }
		}
	}
}

--------- [ Buy Vehicle ] ---------
function showVehicleBuyUI( theVehicle, theVehiclePrice )
	local screenX, screenY = guiGetScreenSize( )

	local width, height = 400, 180
	local x, y = (screenX/2) - (width/2), (screenY/2) - (height/2)
	
	vehicleBuyWin = guiCreateWindow(x, y, width, height, "Buy Vehicle", false)
	
	askLabel = guiCreateLabel(20, 30, 360, 20, "Would you like to buy this ".. getVehicleName(theVehicle) .."?", false, vehicleBuyWin)
	
	local length = guiLabelGetTextExtent(askLabel)
	guiSetPosition(askLabel, (width/2) - (length/2), 30, false)
	
	local priceLbl = guiCreateLabel(153, 60, 94, 20, "Price: $".. theVehiclePrice, false, vehicleBuyWin)
	local taxLbl = guiCreateLabel(153, 80, 94, 20, "Tax: $".. math.ceil( theVehiclePrice*0.001 ), false, vehicleBuyWin)
	
	buttonYes = guiCreateButton(30, 120, 110, 30, "Yes", false, vehicleBuyWin)
	addEventHandler("onClientGUIClick", buttonYes, 
	function( button, state )
		if (button == "left" and state == "up") then
		
			destroyElement(vehicleBuyWin)
			showCursor(false)
			
			local tax = math.ceil( theVehiclePrice*0.001 )
			local realPrice = theVehiclePrice + tax
			
			local money = nil
			money = tonumber(getPlayerMoney(localPlayer)/100)
			money = tonumber(string.format("%.2f", money))
			
			if (money >= realPrice) then
				
				local x, y, z = getElementPosition(theVehicle)
				local _, _, rot = getElementRotation(theVehicle)
				
				triggerServerEvent("buyVehicle", theVehicle, localPlayer, realPrice, x, y, z, rot)
	
				-- Reorder
				triggerServerEvent("reorderVehicle", localPlayer, getVehicleShop( getVehicleName(theVehicle) ), x, y, z, rot)
			else
				outputChatBox("You do not have enough money.", 255, 0, 0)
			end	
		end
	end, false)
	
	buttonNo = guiCreateButton(260, 120, 110, 30, "No", false, vehicleBuyWin)
	addEventHandler("onClientGUIClick", buttonNo, 
	function( button, state )
		if (button == "left" and state == "up") then
			
			destroyElement(vehicleBuyWin)
			showCursor(false)
		end
	end, false)	
	
	guiSetFont(askLabel, "clear-normal")
	guiSetFont(priceLbl, "clear-normal")
	guiSetFont(taxLbl, "clear-normal")
	
	showCursor(true)
end
addEvent("showVehicleBuyUI", true)
addEventHandler("showVehicleBuyUI", localPlayer, showVehicleBuyUI)

function getVehicleShop( vehicleName )
	for k, v in ipairs ( shops ) do
		for i, j in ipairs ( shops[k][2] ) do
			
			if ( j[1] == vehicleName ) then
				
				return k
			end
		end
	end
end

--------- [ Rendering ] ---------
function renderVehicleInformation( )
	local a, b, c = getCameraMatrix( ) 
	
	for key, shop in pairs( getElementsByType( "shop" ) ) do 
		for index, vehicle in ipairs( getElementChildren( shop ) ) do
			
			local vehicleName = getVehicleName( vehicle )
			local price = getVehiclePrice( vehicleName )
			
			local vehicleX, vehicleY, vehicleZ = getElementPosition( vehicle )
			
			local x, y, z = getDrawingPosition( vehicleX, vehicleY, vehicleZ )
			local px, py, pz = getElementPosition(localPlayer)
		
			local distance = getDistanceBetweenPoints3D(x, y, z, px, py, pz)	
			if ( distance <= 15 ) then
				
				local screenX, screenY = getScreenFromWorldPosition(x, y, z + 1.5)
				if (screenX and screenY) then
					
					dxDrawText("Name: ".. tostring(vehicleName), screenX - 65, screenY - 40, screenX, screenY, tocolor(255, 255, 255, 255), 1.5, "clear")
					dxDrawText("Price: $".. tostring(price), screenX - 65, screenY - 20, screenX, screenY, tocolor(255, 255, 255, 255), 1.5, "clear")
					dxDrawText("Tax: $".. tostring(math.ceil( price*0.001 ) ), screenX - 65, screenY, screenX, screenY, tocolor(255, 255, 255, 255), 1.5, "clear")
				end	
			end
		end
	end
end
addEventHandler("onClientRender", root, renderVehicleInformation)

function getVehiclePrice( vehicleName )
	for key, value in ipairs( shops ) do
		
		local t = shops[key][2]
		for i = 1, #t do
			
			if ( tostring( vehicleName ) == t[i][1] ) then
				return t[i][2]
			end	
		end
	end
end	

function getDrawingPosition( vehicleX, vehicleY, vehicleZ )
	for key, value in ipairs( shops ) do
		
		local t = shops[key][1]
		for i = 1, #t do
			
			if ( getDistanceBetweenPoints3D( vehicleX, vehicleY, vehicleZ, t[i][1], t[i][2], t[i][3] ) <= 1.2 ) then
				return t[i][1], t[i][2], t[i][3]
			end	
		end
	end	
end